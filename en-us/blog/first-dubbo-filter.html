<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="first-dubbo-filter" />
	<meta name="description" content="first-dubbo-filter" />
	<!-- 网页标签标题 -->
	<title>first-dubbo-filter</title>
	<link rel="shortcut icon" href="/img/dubbo.ico"/>
	<link rel="stylesheet" href="/build/blogDetail.css" />
</head>
<body>
	<div id="root"><div class="blog-detail-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/en-us/index.html"><img class="logo" src="/img/dubbo_colorful.png"/></a><div class="search search-normal"><span class="icon-search"></span></div><span class="language-switch language-switch-normal">中</span><div class="header-menu"><img class="header-menu-toggle" src="/img/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a href="/en-us/index.html">HOME</a></li><li class="menu-item menu-item-normal"><a href="/en-us/docs/user/quick-start.html">DOCS</a></li><li class="menu-item menu-item-normal"><a href="/en-us/docs/developers/developers_dev.html">DEVELOPERS</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a href="/en-us/blog/index.html">BLOG</a></li><li class="menu-item menu-item-normal"><a href="/en-us/community/index.html">COMMUNITY</a></li><li class="menu-item menu-item-normal"><a href="/en-us/ecology/index.html">ECOSYSTEM</a></li><li class="menu-item menu-item-normal"><a href="/en-us/blog/download.html">DOWNLOAD</a></li></ul></div></div></header><section class="blog-content markdown-body"><h1>First Dubbo Filter</h1>
<h3>Overview</h3>
<p>In overall design of Dubbo, Filter is a very important concept, most of Dubbo's functions are based on this
extension point, and the Filter interception will be executed during each call.</p>
<h4>Extension Mechanism of Dubbo Filter</h4>
<p>There are already about 20 Filters implemented in Dubbo. Their entry is ProtocolFilterWrapper, ProtocolFilterWrapper
makes a Wrapper on Protocol and will be loaded when the extension is loaded. Then, let's see how
the Filter chain is constructed.</p>
<pre><code class="language-java"><span class="hljs-comment">//ProtocolFilterWrapper.java</span>
<span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">Invoker&lt;T&gt; <span class="hljs-title">refer</span><span class="hljs-params">(Class&lt;T&gt; type, URL url)</span> <span class="hljs-keyword">throws</span> RpcException </span>{
        <span class="hljs-keyword">if</span> (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) {
            <span class="hljs-keyword">return</span> protocol.refer(type, url);
        }
        <span class="hljs-keyword">return</span> buildInvokerChain(protocol.refer(type, url), Constants.REFERENCE_FILTER_KEY, Constants.CONSUMER);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-function">Invoker&lt;T&gt; <span class="hljs-title">buildInvokerChain</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Invoker&lt;T&gt; invoker, String key, String group)</span> </span>{
        Invoker&lt;T&gt; last = invoker;
        List&lt;Filter&gt; filters = ExtensionLoader.getExtensionLoader(Filter.class).getActivateExtension(invoker.getUrl(), key, group);
        <span class="hljs-keyword">if</span> (filters.size() &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = filters.size() - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i --) {
                <span class="hljs-keyword">final</span> Filter filter = filters.get(i);
                <span class="hljs-keyword">final</span> Invoker&lt;T&gt; next = last;
                last = <span class="hljs-keyword">new</span> Invoker&lt;T&gt;() {

                    <span class="hljs-function"><span class="hljs-keyword">public</span> Class&lt;T&gt; <span class="hljs-title">getInterface</span><span class="hljs-params">()</span> </span>{
                        <span class="hljs-keyword">return</span> invoker.getInterface();
                    }

                    <span class="hljs-function"><span class="hljs-keyword">public</span> URL <span class="hljs-title">getUrl</span><span class="hljs-params">()</span> </span>{
                        <span class="hljs-keyword">return</span> invoker.getUrl();
                    }

                    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isAvailable</span><span class="hljs-params">()</span> </span>{
                        <span class="hljs-keyword">return</span> invoker.isAvailable();
                    }

                    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">invoke</span><span class="hljs-params">(Invocation invocation)</span> <span class="hljs-keyword">throws</span> RpcException </span>{
                        <span class="hljs-keyword">return</span> filter.invoke(next, invocation);
                    }

                    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">destroy</span><span class="hljs-params">()</span> </span>{
                        invoker.destroy();
                    }

                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{
                        <span class="hljs-keyword">return</span> invoker.toString();
                    }
                };
            }
        }
        <span class="hljs-keyword">return</span> last;
    }

</code></pre>
<h4>Activation Mechanism of Dubbo Filter</h4>
<p>Through the above code we can see that, in the method buildInvokerChain, first get all
activated chains, the chain here is already sorted. Then construct a call chain of Filter
through the Invoker, finally the constructed call chain can be roughly expressed as: Filter1-&gt;Filter2-&gt;Filter3-&gt;......-&gt;Invoker,
now let's see the detailed flow of the activated chain in the above step.</p>
<pre><code class="language-java">    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;T&gt; <span class="hljs-title">getActivateExtension</span><span class="hljs-params">(URL url, String key, String group)</span> </span>{
        String value = url.getParameter(key);
        <span class="hljs-keyword">return</span> getActivateExtension(url, value == <span class="hljs-keyword">null</span> || value.length() == <span class="hljs-number">0</span> ? <span class="hljs-keyword">null</span> : Constants.COMMA_SPLIT_PATTERN.split(value), group);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;T&gt; <span class="hljs-title">getActivateExtension</span><span class="hljs-params">(URL url, String[] values, String group)</span> </span>{
        List&lt;T&gt; exts = <span class="hljs-keyword">new</span> ArrayList&lt;T&gt;();
        
        List&lt;String&gt; names = values == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">new</span> ArrayList&lt;String&gt;(<span class="hljs-number">0</span>) : Arrays.asList(values);

        <span class="hljs-keyword">if</span> (! names.contains(Constants.REMOVE_VALUE_PREFIX + Constants.DEFAULT_KEY)) {
            getExtensionClasses();
            <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Activate&gt; entry : cachedActivates.entrySet()) {
                String name = entry.getKey();
                Activate activate = entry.getValue();
                <span class="hljs-keyword">if</span> (isMatchGroup(group, activate.group())) {
                    T ext = getExtension(name);
                    <span class="hljs-keyword">if</span> (! names.contains(name) &amp;&amp; ! names.contains(Constants.REMOVE_VALUE_PREFIX + name) 
                            &amp;&amp; isActive(activate, url)) {
                        exts.add(ext);
                    }
                }
            }
            Collections.sort(exts, ActivateComparator.COMPARATOR);
        }
        List&lt;T&gt; usrs = <span class="hljs-keyword">new</span> ArrayList&lt;T&gt;();
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; names.size(); i ++) {
            String name = names.get(i);
            <span class="hljs-keyword">if</span> (! name.startsWith(Constants.REMOVE_VALUE_PREFIX)
                    &amp;&amp; ! names.contains(Constants.REMOVE_VALUE_PREFIX + name)) {
                           <span class="hljs-keyword">if</span> (Constants.DEFAULT_KEY.equals(name)) {
                    <span class="hljs-keyword">if</span> (usrs.size() &gt; <span class="hljs-number">0</span>) {
                        exts.addAll(<span class="hljs-number">0</span>, usrs);
                        usrs.clear();
                    }
                } <span class="hljs-keyword">else</span> {
                    T ext = getExtension(name);
                    usrs.add(ext);
                }
            }
        }
        <span class="hljs-keyword">if</span> (usrs.size() &gt; <span class="hljs-number">0</span>) {
            exts.addAll(usrs);
        }
        <span class="hljs-keyword">return</span> exts;
    }
</code></pre>
<p>Through the above code we can see that, some of the Filters configured by the user are activated by default,
and some need to be activated by the configuration file. The loading order of all Filters is to process Dubbo's
default Filter first, and then to process the Filter defined by the user. With the &quot;-&quot; configuration, Dubbo's defualt Filter
can be replaced, with this configuration, the user can flexibly replace or modify the Filter's load order.</p>
<h4>Built-in Filter of Dubbo</h4>
<p>Dubbo has lots of built-in Filter. RpcContext, accesslog and other functions can be implemented by Dubbo.
Now let's see the ConsumerContextFilter which used by the Consumer side for context delivery:</p>
<pre><code class="language-java"><span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">invoke</span><span class="hljs-params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="hljs-keyword">throws</span> RpcException </span>{
        RpcContext.getContext()
                .setInvoker(invoker)
                .setInvocation(invocation)
                .setLocalAddress(NetUtils.getLocalHost(), <span class="hljs-number">0</span>)
                .setRemoteAddress(invoker.getUrl().getHost(), 
                                  invoker.getUrl().getPort());
        <span class="hljs-keyword">if</span> (invocation <span class="hljs-keyword">instanceof</span> RpcInvocation) {
            ((RpcInvocation)invocation).setInvoker(invoker);
        }
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> invoker.invoke(invocation);
        } <span class="hljs-keyword">finally</span> {
            RpcContext.getContext().clearAttachments();
        }
    }
</code></pre>
<p>This Filter records the state information during call, and passes the attachments parameter set
by the client to the server through the invocation object, and these parameters will be cleared
after the call is completed, which is why the request status information can be recorded by times
and delivered.</p>
<h4>Implement A Dubbo Filter</h4>
<p>Because of Dubbo's flexible design and good scalability, we can implement business logic
in the call chain by implementing our own Dubbo Filter, such as time-consuming statistics, monitor information statistics, etc.
Now, let's implement a simple Filter:</p>
<p>Maven project structure:</p>
<pre><code>src
 |-main
    |-java
        |-com
            |-xxx
                |-XxxFilter.java (impelement Filter interface)
    |-resources
        |-META-INF
            |-dubbo
                |-com.alibaba.dubbo.rpc.Filter (Plain text file with content：xxx=com.xxx.XxxFilter)
</code></pre>
<p>XxxFilter.java：</p>
<pre><code class="language-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">XxxFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Filter</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">invoke</span><span class="hljs-params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="hljs-keyword">throws</span> RpcException </span>{
        <span class="hljs-comment">// before filter ...</span>
        Result result = invoker.invoke(invocation);
        <span class="hljs-comment">// after filter ...</span>
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<p>META-INF/dubbo/com.alibaba.dubbo.rpc.Filter：</p>
<pre><code>xxx=com.xxx.XxxFilter
</code></pre>
<p>configure in xml as:</p>
<pre><code class="language-xml"><span class="hljs-comment">&lt;!-- Consumer call process interception --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:reference</span> <span class="hljs-attr">filter</span>=<span class="hljs-string">"xxx"</span> /&gt;</span>
<span class="hljs-comment">&lt;!-- Consumer call process default interception，intercept all reference --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:consumer</span> <span class="hljs-attr">filter</span>=<span class="hljs-string">"xxx"</span>/&gt;</span>
<span class="hljs-comment">&lt;!-- Provider call process interception --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:service</span> <span class="hljs-attr">filter</span>=<span class="hljs-string">"xxx"</span> /&gt;</span>
<span class="hljs-comment">&lt;!-- Provider call process default interception，intercept all service --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:provider</span> <span class="hljs-attr">filter</span>=<span class="hljs-string">"xxx"</span>/&gt;</span>
</code></pre>
<p>or use annotation as:</p>
<pre><code class="language-java"><span class="hljs-meta">@Activate</span>(group = <span class="hljs-string">"consumer"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">XxxFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Filter</span> </span>{
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>Using xml configuration is more flexible and granular.</p>
<p>In before and after, you can implement your own business logic to give the filter a certain function.
Once written and configured, the filter is activated by the Dubbo and executed in the call chain.</p>
</section><footer class="footer-container"><div class="footer-body"><img src="/img/dubbo_gray.png"/><img class="apache" src="/img/apache_logo.png"/><div class="cols-container"><div class="col col-12"><h3></h3><p></p></div><div class="col col-4"><dl><dt>ASF</dt><dd><a href="http://www.apache.org" target="_self">Foundation</a></dd><dd><a href="http://www.apache.org/licenses/" target="_self">License</a></dd><dd><a href="http://www.apache.org/events/current-event" target="_self">Events</a></dd><dd><a href="http://www.apache.org/foundation/sponsorship.html" target="_self">Sponsorship</a></dd><dd><a href="http://www.apache.org/foundation/thanks.html" target="_self">Thanks</a></dd></dl></div><div class="col col-4"><dl><dt>Documentation</dt><dd><a href="/en-us/docs/user/quick-start.html" target="_self">Quick start</a></dd><dd><a href="/en-us/docs/dev/build.html" target="_self">Developer guide</a></dd><dd><a href="/en-us/docs/admin/ops/dubbo-ops.html" target="_self">Admin manual</a></dd><dd><a href="https://github.com/apache/dubbo-website/issues/new" target="_self">Report a Doc Issue</a></dd><dd><a href="https://github.com/apache/dubbo-website" target="_self">Edit This Page on GitHub</a></dd></dl></div><div class="col col-4"><dl><dt>Resources</dt><dd><a href="/en-us/blog/index.html" target="_self">Blog</a></dd><dd><a href="/en-us/community/index.html" target="_self">Community</a></dd><dd><a href="https://www.apache.org/security/" target="_self">Security</a></dd></dl></div></div><div class="copyright"><span>Copyright © 2018-2019 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation.</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '';
  </script>
  <script src="/build/blogDetail.js"></script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-112489517-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-112489517-1');
	</script>
</body>
</html>