{
  "filename": "introduction.md",
  "__html": "<h1>Background</h1>\n<p>There are close to <a href=\"http://dubbo.apache.org/en-us/docs/user/references/xml/dubbo-service.html\">30 configurations</a> in dubbo provider. Excluding registry center governance requirements, a large part of configurations are used by the provider itself and do not need to be delivered to the consumer. This part of the data does not need to be written to the registry, but only needs to be persisted as key-value.\nThere are also <a href=\"http://dubbo.apache.org/en-us/docs/user/references/xml/dubbo-reference.html\">20+ configurations</a> in dubbo consumer. In the registry center, only a few configurations such as application, version, group, ip, dubbo version are needed in the list of service consumers. Other configurations can also be persisted in key-value form.\nThis data is registered into the registry in the service dimension, which leads to the expansion of data volume, and then causes the increased network overhead of the registry (such as zookeeper) and decreased performance.</p>\n<p>In addition to the storage of the above configuration items, Dubbo service metadata information also needs to be stored. Metadata information includes service interface and method information of interface. This information will be used for service mock, service test.</p>\n<h1>Goal</h1>\n<p>The original data and metadata information in the registry center need to be stored in a separate key-value store, which can be DB, redis or other persistent storage. The core code supports zookeeper, redis(recommended) by default.</p>\n<p>The format of provider storage content is the storage after gson's serialization of org.apache.dubbo.metadata.definition.model.FullServiceDefinition.\nConsumer gets parameter information from the URL that it wrote to the registry and stores it in Map. That is, get the Map with URL.getParameterMap() and store it after gson's serialization.</p>\n<p>For more details, you can refer to the sample below.</p>\n<h1>Configuration</h1>\n<p>The default metadata storage supports the following additional features:</p>\n<ul>\n<li>Failed retry</li>\n<li>Refresh regularly</li>\n</ul>\n<h4>Failed retry</h4>\n<p>Failed retries can be configured by retrytimes (retry times, default 100), retryperiod (retry cycle, default 3000ms).</p>\n<h4>Refresh regularly</h4>\n<p>It's opening by default and can be turned off by setting cycleReport=false.</p>\n<h4>Complete configurations:</h4>\n<pre><code>dubbo.metadata-report.address=zookeeper://127.0.0.1:2181\ndubbo.metadata-report.username=xxx        ##Not necessary\ndubbo.metadata-report.password=xxx        ##Not necessary\ndubbo.metadata-report.retry-times=30       ##Not necessary,default 100\ndubbo.metadata-report.retry-period=5000    ##Not necessary,default 3000\ndubbo.metadata-report.cycle-report=false   ##Not necessary,default true\n</code></pre>\n<blockquote>\n<p>If the metadata address (dubbo.metadata-report.address) is not configured, the writing of the entire metadata will not take effect, but it will not affect the running of the program.</p>\n</blockquote>\n<p>Let's look at a few sample configurations. Regardless of the configuration, some maven dependencies need to be introduced:</p>\n<pre><code>&lt;dependency&gt;\n    &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;\n    &lt;artifactId&gt;dubbo-metadata-report-zookeeper&lt;/artifactId&gt;\n&lt;/dependency&gt;\n</code></pre>\n<p>If redis is needed, the corresponding redis dependencies can be introduced:</p>\n<pre><code>&lt;dependency&gt;\n    &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;\n    &lt;artifactId&gt;dubbo-metadata-report-redis&lt;/artifactId&gt;\n&lt;/dependency&gt;\n</code></pre>\n<blockquote>\n<p><strong>Complete sample，refer to<a href=\"https://github.com/dubbo/dubbo-samples/tree/master\">sample-2.7</a></strong></p>\n</blockquote>\n<h2>Method 1: Config in Configcenter</h2>\n<p>Refer to the sample: dubbo-samples-metadata-report/dubbo-samples-metadata-report-configcenter.</p>\n<h5>Configcenter Configuration</h5>\n<p>Configurations of Configcenter，can refer to the document of Configcenter. As follows:</p>\n<pre><code class=\"language-.properties\">dubbo.registry.address=zookeeper://127.0.0.1:2181\n### Notice the hump style\ndubbo.metadata-report.address=zookeeper://127.0.0.1:2181 ###Address of metadata storage\n</code></pre>\n<p>In the sample, Zookeeper is used as the Configcenter. Run directly: org.Apache.Dubbo.Samples.Metadatareport.Configcenter.ZKTools after starting a local zookeeper service, then writing finished.\nYou can also use Nacos, Apollo as the Configcenter. These products themselves support ops configuration.</p>\n<h5>Application Configuration</h5>\n<pre><code>###dubbo.properties\ndubbo.config-center.address=zookeeper://127.0.0.1:2181\n... \n</code></pre>\n<p>After completing the above two steps, the registry address and metadata address are retrieved from the Configcenter. You can now run the Provider and the Consumer in turn and get the corresponding output in console or view it directly through the client of zookeeper.</p>\n<h5>Provider Configuration</h5>\n<p>The metadata stored on the Provider side is as follows:</p>\n<pre><code class=\"language-json\">{\n <span class=\"hljs-attr\">\"parameters\"</span>: {\n  <span class=\"hljs-attr\">\"side\"</span>: <span class=\"hljs-string\">\"provider\"</span>,\n  <span class=\"hljs-attr\">\"methods\"</span>: <span class=\"hljs-string\">\"sayHello\"</span>,\n  <span class=\"hljs-attr\">\"dubbo\"</span>: <span class=\"hljs-string\">\"2.0.2\"</span>,\n  <span class=\"hljs-attr\">\"threads\"</span>: <span class=\"hljs-string\">\"100\"</span>,\n  <span class=\"hljs-attr\">\"interface\"</span>: <span class=\"hljs-string\">\"org.apache.dubbo.samples.metadatareport.configcenter.api.AnnotationService\"</span>,\n  <span class=\"hljs-attr\">\"threadpool\"</span>: <span class=\"hljs-string\">\"fixed\"</span>,\n  <span class=\"hljs-attr\">\"version\"</span>: <span class=\"hljs-string\">\"1.1.1\"</span>,\n  <span class=\"hljs-attr\">\"generic\"</span>: <span class=\"hljs-string\">\"false\"</span>,\n  <span class=\"hljs-attr\">\"revision\"</span>: <span class=\"hljs-string\">\"1.1.1\"</span>,\n  <span class=\"hljs-attr\">\"valid\"</span>: <span class=\"hljs-string\">\"true\"</span>,\n  <span class=\"hljs-attr\">\"application\"</span>: <span class=\"hljs-string\">\"metadatareport-configcenter-provider\"</span>,\n  <span class=\"hljs-attr\">\"default.timeout\"</span>: <span class=\"hljs-string\">\"5000\"</span>,\n  <span class=\"hljs-attr\">\"group\"</span>: <span class=\"hljs-string\">\"d-test\"</span>,\n  <span class=\"hljs-attr\">\"anyhost\"</span>: <span class=\"hljs-string\">\"true\"</span>\n },\n <span class=\"hljs-attr\">\"canonicalName\"</span>: <span class=\"hljs-string\">\"org.apache.dubbo.samples.metadatareport.configcenter.api.AnnotationService\"</span>,\n <span class=\"hljs-attr\">\"codeSource\"</span>: <span class=\"hljs-string\">\"file:/Users/cvictory/workspace/work-mw/dubbo-samples/dubbo-samples-metadata-report/dubbo-samples-metadata-report-configcenter/target/classes/\"</span>,\n <span class=\"hljs-attr\">\"methods\"</span>: [{\n  <span class=\"hljs-attr\">\"name\"</span>: <span class=\"hljs-string\">\"sayHello\"</span>,\n  <span class=\"hljs-attr\">\"parameterTypes\"</span>: [<span class=\"hljs-string\">\"java.lang.String\"</span>],\n  <span class=\"hljs-attr\">\"returnType\"</span>: <span class=\"hljs-string\">\"java.lang.String\"</span>\n }],\n <span class=\"hljs-attr\">\"types\"</span>: [{\n  <span class=\"hljs-attr\">\"type\"</span>: <span class=\"hljs-string\">\"java.lang.String\"</span>,\n  <span class=\"hljs-attr\">\"properties\"</span>: {\n   <span class=\"hljs-attr\">\"value\"</span>: {\n    <span class=\"hljs-attr\">\"type\"</span>: <span class=\"hljs-string\">\"char[]\"</span>\n   },\n   <span class=\"hljs-attr\">\"hash\"</span>: {\n    <span class=\"hljs-attr\">\"type\"</span>: <span class=\"hljs-string\">\"int\"</span>\n   }\n  }\n }, {\n  <span class=\"hljs-attr\">\"type\"</span>: <span class=\"hljs-string\">\"int\"</span>\n }, {\n  <span class=\"hljs-attr\">\"type\"</span>: <span class=\"hljs-string\">\"char\"</span>\n }]\n}\n\n</code></pre>\n<p>The Provider side stores all the parameters that the Provider service fills in to the registry, as well as the method information of the service (method name, input and output format).</p>\n<h5>Consumer Configuration</h5>\n<pre><code>{\n &quot;valid&quot;: &quot;true&quot;,\n &quot;side&quot;: &quot;consumer&quot;,\n &quot;application&quot;: &quot;metadatareport-configcenter-consumer&quot;,\n &quot;methods&quot;: &quot;sayHello&quot;,\n &quot;default.timeout&quot;: &quot;6666&quot;,\n &quot;dubbo&quot;: &quot;2.0.2&quot;,\n &quot;interface&quot;: &quot;org.apache.dubbo.samples.metadatareport.configcenter.api.AnnotationService&quot;,\n &quot;version&quot;: &quot;1.1.1&quot;,\n &quot;revision&quot;: &quot;1.1.1&quot;,\n &quot;group&quot;: &quot;d-test&quot;\n}\n</code></pre>\n<p>The Consumer side stores all the parameters that the Consumer fills in to the registry.</p>\n<p>The above example is mainly a presentation of the provider side service information and consumer side service information stored in the metadata area by placing the metadata address in the Configcenter.\nThe next two examples focus on configuring in a project: the XML mode and the annotation mode .</p>\n<h2>Method 2: Config project in properties way</h2>\n<p>Refer to the sample: dubbo-samples-metadata-report/dubbo-samples-metadata-report-local-xml.</p>\n<h5>dubbo.properties</h5>\n<pre><code>dubbo.metadata-report.address=zookeeper://127.0.0.1:2181\n</code></pre>\n<p>After setting this configuration, have not to focus on others. You can also view the service information of the corresponding provider and consumer directly.</p>\n<h5>Provider stores:</h5>\n<pre><code>{\n &quot;parameters&quot;: {\n  &quot;valid&quot;: &quot;true&quot;,\n  &quot;async&quot;: &quot;true&quot;,\n  &quot;side&quot;: &quot;provider&quot;,\n  &quot;application&quot;: &quot;metadatareport-local-xml-provider&quot;,\n  &quot;methods&quot;: &quot;sayHello&quot;,\n  &quot;dubbo&quot;: &quot;2.0.2&quot;,\n  &quot;interface&quot;: &quot;org.apache.dubbo.samples.metadatareport.local.xml.api.DemoService&quot;,\n  &quot;generic&quot;: &quot;false&quot;,\n  &quot;anyhost&quot;: &quot;true&quot;\n },\n &quot;canonicalName&quot;: &quot;org.apache.dubbo.samples.metadatareport.local.xml.api.DemoService&quot;,\n &quot;codeSource&quot;: &quot;file:/Users/cvictory/workspace/work-mw/dubbo-samples/dubbo-samples-metadata-report/dubbo-samples-metadata-report-local-xml/target/classes/&quot;,\n &quot;methods&quot;: [{\n  &quot;name&quot;: &quot;sayHello&quot;,\n  &quot;parameterTypes&quot;: [&quot;java.lang.String&quot;],\n  &quot;returnType&quot;: &quot;java.lang.String&quot;\n }],\n &quot;types&quot;: [{\n  &quot;type&quot;: &quot;int&quot;\n }, {\n  &quot;type&quot;: &quot;char&quot;\n }, {\n  &quot;type&quot;: &quot;java.lang.String&quot;,\n  &quot;properties&quot;: {\n   &quot;value&quot;: {\n    &quot;type&quot;: &quot;char[]&quot;\n   },\n   &quot;hash&quot;: {\n    &quot;type&quot;: &quot;int&quot;\n   }\n  }\n }]\n}\n\n</code></pre>\n<h5>Consumer stores:</h5>\n<pre><code>{\n &quot;valid&quot;: &quot;true&quot;,\n &quot;side&quot;: &quot;consumer&quot;,\n &quot;application&quot;: &quot;metadatareport-local-xml-consumer&quot;,\n &quot;methods&quot;: &quot;sayHello&quot;,\n &quot;dubbo&quot;: &quot;2.0.2&quot;,\n &quot;interface&quot;: &quot;org.apache.dubbo.samples.metadatareport.local.xml.api.DemoService&quot;\n}\n\n</code></pre>\n<h2>Method 3: Config project in annotation way</h2>\n<p>Refer to the sample: dubbo-samples-metadata-report/dubbo-samples-metadata-report-local-annotaion.</p>\n<h5>@Bean introduce Bean</h5>\n<pre><code>@Bean\npublic MetadataReportConfig metadataReportConfig() {\n    MetadataReportConfig metadataReportConfig = new MetadataReportConfig();\n    metadataReportConfig.setAddress(&quot;zookeeper://127.0.0.1:2181&quot;);\n    return metadataReportConfig;\n}\n\n</code></pre>\n<p>After introducing Bean, also have not to set others. View corresponding service information directly:</p>\n<h5>Provider stores:</h5>\n<pre><code>{\n &quot;parameters&quot;: {\n  &quot;side&quot;: &quot;provider&quot;,\n  &quot;methods&quot;: &quot;sayHello&quot;,\n  &quot;dubbo&quot;: &quot;2.0.2&quot;,\n  &quot;interface&quot;: &quot;org.apache.dubbo.samples.metadatareport.local.annotation.api.AnnotationService&quot;,\n  &quot;version&quot;: &quot;1.1.8&quot;,\n  &quot;generic&quot;: &quot;false&quot;,\n  &quot;revision&quot;: &quot;1.1.8&quot;,\n  &quot;valid&quot;: &quot;true&quot;,\n  &quot;application&quot;: &quot;metadatareport-local-annotaion-provider&quot;,\n  &quot;default.timeout&quot;: &quot;1000&quot;,\n  &quot;group&quot;: &quot;d-test&quot;,\n  &quot;anyhost&quot;: &quot;true&quot;\n },\n &quot;canonicalName&quot;: &quot;org.apache.dubbo.samples.metadatareport.local.annotation.api.AnnotationService&quot;,\n &quot;codeSource&quot;: &quot;file:/Users/cvictory/workspace/work-mw/dubbo-samples/dubbo-samples-metadata-report/dubbo-samples-metadata-report-local-annotaion/target/classes/&quot;,\n &quot;methods&quot;: [{\n  &quot;name&quot;: &quot;sayHello&quot;,\n  &quot;parameterTypes&quot;: [&quot;java.lang.String&quot;],\n  &quot;returnType&quot;: &quot;java.lang.String&quot;\n }],\n &quot;types&quot;: [{\n  &quot;type&quot;: &quot;int&quot;\n }, {\n  &quot;type&quot;: &quot;java.lang.String&quot;,\n  &quot;properties&quot;: {\n   &quot;value&quot;: {\n    &quot;type&quot;: &quot;char[]&quot;\n   },\n   &quot;hash&quot;: {\n    &quot;type&quot;: &quot;int&quot;\n   }\n  }\n }, {\n  &quot;type&quot;: &quot;char&quot;\n }]\n}\n</code></pre>\n<h5>Consumer stores:</h5>\n<pre><code>{\n &quot;valid&quot;: &quot;true&quot;,\n &quot;side&quot;: &quot;consumer&quot;,\n &quot;application&quot;: &quot;metadatareport-local-annotaion-consumer&quot;,\n &quot;methods&quot;: &quot;sayHello&quot;,\n &quot;dubbo&quot;: &quot;2.0.2&quot;,\n &quot;interface&quot;: &quot;org.apache.dubbo.samples.metadatareport.local.annotation.api.AnnotationService&quot;,\n &quot;version&quot;: &quot;1.1.8&quot;,\n &quot;revision&quot;: &quot;1.1.8&quot;,\n &quot;group&quot;: &quot;d-test&quot;\n}\n</code></pre>\n<h1>Extension</h1>\n<h2>SPI Definition</h2>\n<p>Refer to: org.apache.dubbo.metadata.store.MetadataReportFactory, org.apache.dubbo.metadata.store.MetadataReport</p>\n<pre><code>@SPI(&quot;redis&quot;)\npublic interface MetadataReportFactory {\n    @Adaptive({&quot;protocol&quot;})\n    MetadataReport getMetadataReport(URL url);\n}\n</code></pre>\n<h2>Custom metadata storage</h2>\n<p>Let's take Redis storage as an example to illustrate.</p>\n<p>Create a new project supporting the following modifications:</p>\n<h4>Extend AbstractMetadataReport</h4>\n<pre><code>public class RedisMetadataReport extends AbstractMetadataReport {\n    private final static Logger logger = LoggerFactory.getLogger(RedisMetadataReport.class);\n    final JedisPool pool;\n\t\n    public RedisMetadataReport(URL url) {\n        super(url);\n        pool = new JedisPool(new JedisPoolConfig(), url.getHost(), url.getPort());\n    }\n    @Override\n    protected void doStoreProviderMetadata(ProviderMetadataIdentifier providerMetadataIdentifier, String serviceDefinitions) {\n        this.storeMetadata(providerMetadataIdentifier, serviceDefinitions);\n    }\n    @Override\n    protected void doStoreConsumerMetadata(ConsumerMetadataIdentifier consumerMetadataIdentifier, String value) {\n        this.storeMetadata(consumerMetadataIdentifier, value);\n    }\n    private void storeMetadata(MetadataIdentifier metadataIdentifier, String v) {\n        try (Jedis jedis = pool.getResource()) {\n            jedis.set(metadataIdentifier.getIdentifierKey() + META_DATA_SOTRE_TAG, v);\n        } catch (Throwable e) {\n            logger.error(&quot;Failed to put &quot; + metadataIdentifier + &quot; to redis &quot; + v + &quot;, cause: &quot; + e.getMessage(), e);\n            throw new RpcException(&quot;Failed to put &quot; + metadataIdentifier + &quot; to redis &quot; + v + &quot;, cause: &quot; + e.getMessage(), e);\n        }\n    }\n}\n</code></pre>\n<h4>Extend AbstractMetadataReportFactory</h4>\n<pre><code>public class RedisMetadataReportFactory extends AbstractMetadataReportFactory {\n    @Override\n    public MetadataReport createMetadataReport(URL url) {\n        return new RedisMetadataReport(url);\n    }\n}\n</code></pre>\n<h4>New META-INF/dubbo/internal/org.apache.dubbo.metadata.store.MetadataReportFactory</h4>\n<pre><code>redis=org.apache.dubbo.metadata.store.redis.RedisMetadataReportFactory\n</code></pre>\n<p>As long as the above modifications along with the project are packaged into a jar, then config metadata center url: redis://10.20.153.10:6379.</p>\n<p>Up to now, a custom metadata store is ready to run.</p>\n",
  "link": "/en-us/docs/user/references/metadata/introduction.html",
  "meta": {}
}